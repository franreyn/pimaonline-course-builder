<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./grapesjs/grapes.min.css">
  <script src="./grapesjs/grapes.min.js"></script>
  <title>Course Builder</title>
</head>
<body>
  <div class="menu-bar">
    <button id="btn-save">Save</button>
    <button id="btn-save-as">Save As</button>
    <button id="btn-open">Open</button>
    <button id="btn-export">Export HTML</button>
  </div>
  
  <div class="panel__top">
    <div class="panel__basic-actions"></div>
    <div class="panel__devices"></div>
    <div class="panel__switcher"></div>
  </div>  
  <div class="editor-row">
    <div class="editor-canvas">
      <div id="gjs">
        <!-- <h1>Hello World Component!</h1> -->
      </div>
    </div>
    <div class="panel__right">
      <div class="layers-container"></div>
      <div class="styles-container"></div>
      <div class="traits-container"></div>
    </div>
  </div>  
  <div id="blocks"></div>

  <style>
    /* Let's highlight canvas boundaries */
    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
  
    #gjs {
      border: 3px solid #444;
      height: 100%;
      width: 100%;
    }
  
    /* Reset some default styling */
    .gjs-cv-canvas {
      top: 0;
      width: 100%;
      height: 100%;
    }
  
    .gjs-block {
      width: auto;
      height: auto;
      min-height: auto;
    }
  
    .panel__top {
      padding: 0;
      width: 100%;
      display: flex;
      position: initial;
      justify-content: center;
      justify-content: space-between;
    }
  
    .panel__basic-actions {
      position: initial;
    }
  
    .editor-row {
      display: flex;
      justify-content: flex-start;
      align-items: stretch;
      flex-wrap: nowrap;
      flex-grow: 1; /* Added to fill the remaining space */
    }
  
    .editor-canvas {
      flex-grow: 1;
    }
  
    .panel__right {
      flex-basis: 230px;
      position: relative;
      overflow-y: auto;
      height: 100%; /* Added to make it full height */
    }
  
    .panel__switcher {
      position: initial;
    }
  
    .panel__devices {
      position: initial;
    }

    /* Menu Bar  */
    .menu-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      background-color: #333;
      padding: 10px;
      color: white;
      font-family: sans-serif;
    }

    .menu-bar button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      font-size: 14px;
      margin: 0 10px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .menu-bar button:hover {
      background-color: #45a049;
    }

  </style>
  

  <script type="text/javascript">
    let currentFileName = null;

    function setCustomLayerName(component) {
      switch (component.get('type')) {
        case 'text':
          component.set('title', 'Custom Text Layer');
          break;
        case 'image':
          component.set('title', 'Custom Image Layer');
          break;
        default:
          component.set('title', 'Custom Layer');
      }
    }

    //=== Init ===//
    const editor = grapesjs.init({
      container: '#gjs',
      autorender: 0,
      fromElement: true,
      height: '100%',
      width: 'auto',
      storageManager: true,
      panels: { defaults: [] },
      layerManager: {
        appendTo: '.layers-container'
      },
      traitManager: {
       appendTo: '.traits-container',
      },  
      canvas: {
        // scripts: ['https://.../somelib.min.js'], // Link any scripts here
        scripts:  [
                  'https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js', 
                  'https://cdn.jsdelivr.net/npm/@pimaonline/pimaonline-themepack/dist/js/scripts2.js'
                  ], 
        // styles: ['./components.css'], // Link any stylesheets here
        styles: [
                  'https://cdn.jsdelivr.net/npm/@pimaonline/pimaonline-themepack/dist/css/themes/cards/styles.css'
                ],
      },          
      // We define a default panel as a sidebar to contain layers
      panels: {
        defaults: [{
            id: 'layers',
            el: '.panel__right',  
            // Make the panel resizable
            resizable: {
              maxDim: 350,
              minDim: 200,
              tc: 0, // Top handler
              cl: 1, // Left handler
              cr: 0, // Right handler
              bc: 0, // Bottom handler
              // Being a flex child we need to change `flex-basis` property
              // instead of the `width` (default)
              keyWidth: 'flex-basis',
            },
          },
          {
            id: 'panel-devices',
            el: '.panel__devices',
            buttons: [{
                id: 'device-desktop',
                label: 'Desktop',
                command: 'set-device-desktop',
                active: true,
                togglable: false,
              }, {
                id: 'device-mobile',
                label: 'Mobile',
                command: 'set-device-mobile',
                togglable: false,
            }],
          },
          {
            id: 'panel-switcher',
            el: '.panel__switcher',
            buttons: [{
              id: 'show-layers',
              active: true,
              label: 'Layers',
              command: 'show-layers',
              // Once activated disable the possibility to turn it off
              togglable: false,
              }, {
              id: 'show-style',
              active: true,
              label: 'Styles',
              command: 'show-styles',
              togglable: false,
              },           
              {
              id: 'show-traits',
              active: true,
              label: 'Traits',
              command: 'show-traits',
              togglable: false,
              },              
            ],
          }]
      },
      // The Selector Manager allows to assign classes and
      // different states (eg. :hover) on components.
      // Generally, it's used in conjunction with Style Manager
      // but it's not mandatory
      // =====
      selectorManager: {
        appendTo: '.styles-container'
      },
      // Storage manager
      storageManager: {
        id: 'gjs-',             // Prefix identifier that will be used inside storing and loading
        type: 'local',          // Type of the storage
        autosave: false,         // Store data automatically
        autoload: false,         // Autoload stored data on init
        stepsBeforeSave: 1,     // If autosave enabled, indicates how many changes are necessary before store method is triggered
        storeComponents: true,  // Enable/Disable storing of components in JSON format
        storeStyles: true,      // Enable/Disable storing of rules in JSON format
        storeHtml: true,        // Enable/Disable storing of components as HTML string
        storeCss: true,         // Enable/Disable storing of rules as CSS string
      },
      // Block manager
      blockManager: {
        appendTo: '#blocks',
        blocks: [
          {
            id: 'one-column', // id is mandatory
            label: '<b>One Column</b>', // You can use HTML/SVG inside labels
            // attributes: { class:'gjs-block-section' },
            category: 'Layout',
            content: { type: 'one-column' },
          }, 
          {
            id: 'two-column', // id is mandatory
            label: '<b>Two Column</b>', // You can use HTML/SVG inside labels
            // attributes: { class:'gjs-block-section' },
            category: 'Layout',
            content: { type: 'two-column' },
          }, 
          {
            id: 'text',
            category: 'Widgets',
            label: 'Text',
            content: '<div data-gjs-type="text">Insert your text here</div>',
          }, 
          {
            id: 'image',
            category: 'Widgets',
            label: 'Image',
            // Select the component once it's dropped
            select: true,
            // You can pass components as a JSON instead of a simple HTML string,
            // in this case we also use a defined component type `image`
            content: { type: 'image' },
            // This triggers `active` event on dropped components and the `image`
            // reacts by opening the AssetManager
            activate: true,
          }
        ]
      },  
      // Device manager
      deviceManager: {
        devices: [{
            name: 'Desktop',
            width: '', // default size
          }, {
            name: 'Mobile',
            width: '320px', // this value will be used on canvas width
            widthMedia: '480px', // this value will be used in CSS @media
        }]
      }
    });
    //=== end init ===//
    //=== end init ===//
    //=== end init ===//

    // Set the canvas height and width to 100%
    editor.setComponents(`
      <style>
        body, html {
          height: 100%;
          margin: 0;
          padding: 0;
        }
      </style>
    `);

    // Render the editor
    editor.render();

    editor.on('component:title', setCustomLayerName);

    // == Create one column component
    editor.DomComponents.addType('one-column', {
      model: {
        defaults: {
          tagName: 'div',
          components: `
            <div id="content-wrapper">
              <div class="content-body">
                <h2>Subheading</h2>
              </div
            </div>
          `
        }
      }
    });
    // == Create two column components
    editor.DomComponents.addType('two-column', {
      model: {
        defaults: {
          tagName: 'div',
          components: `
            <div id="content-wrapper">
              <div class="content-body">
                <h2>Subheading</h2>
              </div
            </div>
            <div id="second-column">
              <div class="content-body">
                <h2>Subheading</h2>
              </div
            </div>            
          `
        }
      }
    });

    editor.Commands.add('remove-sibling-components', {
      run(editor, sender, data) {
        const component = data.component;
        const parent = component.parent();
        const siblings = parent.components();
        siblings.forEach((sibling) => {
          if (sibling !== component) {
            sibling.remove();
            // Trigger a custom event after removing the component
            sibling.trigger('custom:update');
          }
        });
      }
    });

    let columnComponentCount = 0;
    editor.on('component:add', (component) => {
      if (component.get('type') === 'one-column' || component.get('type') === 'two-column') {
        columnComponentCount += 1;
        if (columnComponentCount > 1) {
          const confirmSwitch = window.confirm('Your content will be deleted if you switch layouts, are you sure?');
          if (confirmSwitch) {
            const doubleCheck = window.confirm("Just double checking you're sure.");
            if (doubleCheck) {
              editor.runCommand('remove-sibling-components', { component });
            } else {
              component.remove(); // Remove the component if the user cancels the second confirmation
            }
          } else {
            component.remove(); // Remove the component if the user cancels the first confirmation
          }
        }
      }
      setCustomLayerName(component);
      editor.LayerManager.render(); // Force layers panel to refresh
    });


    editor.on('component:remove', (component) => {
      editor.LayerManager.render(); // Force layers panel to refresh
    });





    //=== Top Panel =====//
    editor.Panels.addPanel({
      id: 'panel-top',
      el: '.panel__top',
    });
    editor.Panels.addPanel({
      id: 'basic-actions',
      el: '.panel__basic-actions',
      buttons: [
        {
          id: 'visibility',
          active: true, // active by default
          className: 'btn-toggle-borders',
          label: '<b>Course Builder</b>',
          command: 'sw-visibility', // Built-in command
        }, 
        {
          id: 'export',
          className: 'btn-open-export',
          label: 'Exp',
          command: 'export-template',
          context: 'export-template', // For grouping context of buttons from the same panel
        }, 
      ],
    }); 
    //=== end top panel ===//
        
    //=== Define commands ===//
    editor.Commands.add('show-layers', {
      getRowEl(editor) { return editor.getContainer().closest('.editor-row'); },
      getLayersEl(row) { return row.querySelector('.layers-container') },

      run(editor, sender) {
        const lmEl = this.getLayersEl(this.getRowEl(editor));
        lmEl.style.display = '';
      },
      stop(editor, sender) {
        const lmEl = this.getLayersEl(this.getRowEl(editor));
        lmEl.style.display = 'none';
      },
    });
    editor.Commands.add('show-styles', {
      getRowEl(editor) { return editor.getContainer().closest('.editor-row'); },
      getStyleEl(row) { return row.querySelector('.styles-container') },

      run(editor, sender) {
        const smEl = this.getStyleEl(this.getRowEl(editor));
        smEl.style.display = '';
      },
      stop(editor, sender) {
        const smEl = this.getStyleEl(this.getRowEl(editor));
        smEl.style.display = 'none';
      },
    });    
    // End Define commands ===//

    //=== Device manager commands ===//
    editor.Commands.add('set-device-desktop', {
      run: editor => editor.setDevice('Desktop')
    });
    editor.Commands.add('set-device-mobile', {
      run: editor => editor.setDevice('Mobile')
    });

    // Traits manager commands
    editor.Commands.add('show-traits', {
      getTraitsEl(editor) {
        const row = editor.getContainer().closest('.editor-row');
        return row.querySelector('.traits-container');
      },
      run(editor, sender) {
        this.getTraitsEl(editor).style.display = '';
      },
      stop(editor, sender) {
        this.getTraitsEl(editor).style.display = 'none';
      },
    });

    //=== Save/Open/export feature
    // Save
    async function saveToLocal(editor, saveAs = false) {
      if (!currentFileName || saveAs) {
        saveWithDialog(editor);
      } else {
        try {
          const handle = await window.showDirectoryPicker();
          const fileHandle = await handle.getFileHandle(currentFileName, { create: true });
          const writable = await fileHandle.createWritable();
          const json = JSON.stringify(editor.getComponents());
          await writable.write(json);
          await writable.close();
        } catch (error) {
          console.error('Error saving file:', error);
        }
      }
    }
    // Save As
    function saveWithDialog(editor) {
      const json = JSON.stringify(editor.getComponents());
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "grapesjs-layout.json";
      link.click();
      currentFileName = link.download;
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }
    // Open
    function openFromLocal(editor) {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
          currentFileName = file.name;
          const reader = new FileReader();
          reader.onload = (e) => {
            const json = e.target.result;
            try {
              const components = JSON.parse(json);
              editor.setComponents(components);
            } catch (error) {
              alert("Invalid file format.");
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    // Buttons
    const btnSave = document.getElementById("btn-save");
    btnSave.addEventListener("click", () => saveToLocal(editor, false));

    const btnSaveAs = document.getElementById("btn-save-as");
    btnSaveAs.addEventListener("click", () => saveToLocal(editor, true));

    const btnOpen = document.getElementById("btn-open");
    btnOpen.addEventListener("click", () => openFromLocal(editor));
    // ===

    // === Export 
    document.getElementById('btn-export').addEventListener('click', function() {
      const filename = 'exported.html';
      const htmlContent = editor.getHtml();
      const cssContent = editor.getCss();
      const content = `
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exported HTML</title>
</head>
<body>
${htmlContent}
<body>
</html>
`;
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    });
    // Buttons
    document.getElementById('btn-export').addEventListener('click', exportHTML);


    // ==
  </script>
</body>
</html>